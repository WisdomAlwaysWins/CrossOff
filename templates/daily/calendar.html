{% extends 'layout.html' %}
{% load static %}
{% block title %}
Days
{% endblock title %}
{% block js %}
<script>
  const midGoal = JSON.parse(
    "{{manda_mid}}"
      .replace(/&quot;/g, '"')
      .replace(/\r/gi, "\\r")
      .replace(/\n/gi, "\\n")
      .replace(/\t/gi, "\\t")
      .replace(/\f/gi, "\\f")
  );
  const detailGoal = JSON.parse(
    "{{manda_small}}"
      .replace(/&quot;/g, '"')
      .replace(/\r/gi, "\\r")
      .replace(/\n/gi, "\\n")
      .replace(/\t/gi, "\\t")
      .replace(/\f/gi, "\\f")
  );
  const abc = JSON.parse(
    "{{blocks}}"
      .replace(/&quot;/g, '"')
      .replace(/\r/gi, "\\r")
      .replace(/\n/gi, "\\n")
      .replace(/\t/gi, "\\t")
      .replace(/\f/gi, "\\f")
  );
</script>
{% endblock js %}
{% block css %}
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="{% static 'css/calendar.css' %} ">
{% endblock css %}
{% block content %}
<div class="main">
  <div class="content-wrap">
    <div class="content-right">
      <table id="calendar" align="center">
        <thead>
          <tr class="btn-wrap clearfix">
            <td>
              <label id="prev">
                &#60;
              </label>
            </td>
            <td align="center" id="current-year-month" colspan="5"></td>
            <td>
              <label id="next">
                &#62;
              </label>
            </td>
          </tr>
          <tr>
            <td class="sun" align="center">Sun</td>
            <td align="center">Mon</td>
            <td align="center">Tue</td>
            <td align="center">Wed</td>
            <td align="center">Thu</td>
            <td align="center">Fri</td>
            <td class="sat" align="center">Sat</td>
          </tr>
        </thead>
        <tbody id="calendar-body" class="calendar-body"></tbody>
      </table>
    </div>
    <div class="content-left">
      <div class="main-wrap">
        <div id="main-day" class="main-day"></div>
        <div id="main-date" class="main-date"></div>
      </div>
      <div class="todo-wrap">
        <div class="input-wrap">
          <div class="selection__content">
            <form action="{% url 'daily:addblock' %}" method="POST">
              {% csrf_token %}
              <input type="hidden" id="hdate" name="date">
              <form action="" class="selection_form" method="GET">
                <select name="midSelectedBox" id="midSelectedBox">
                </select>
                <select name="detailedSelectedBox" id="detailedSelectedBox">

                </select>
                <button class="addBtn" type="button">추가</button>
                <div class="selectedGoalContent">
                  <ul id="selected-list">
                  </ul>
                </div>
                <textarea id="input-box" class="input-box" type="text" cols="30" rows="5"
                  placeholder="글로 남기고 싶은 오늘 하루를 기록하세요 :)" name=content>
                </textarea>
                <input type="submit" id="save-data" class="save-data" value="저장">
              </form>
            </form>
          </div>

          <div id="input-list" class="input-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  /* Fill Mid Goal Select  */
  const midSelectedBox = document.querySelector('#midSelectedBox');
  const maxGoalNum = 8;

  // Fill Option
  function fillOption(goal_name, select_name) {
    for (let i = 0; i < maxGoalNum; i++) {
      if (goal_name[i].length != 0) {
        let option = document.createElement('option');
        let content = goal_name[i];
        option.value = i;
        option.text = content;
        select_name.append(option);
      }
    }
  }
  function fillMidGoal() {
    fillOption(midGoal, midSelectedBox);
  }
  fillMidGoal();
  const detailedSelectedBox = document.querySelector('#detailedSelectedBox');
  // <!-- 기본값으로 첫번째 Mid Goal의 세부 목표를 넣어놨습니다. -->
  for (let n = 0; n < 8; n++) {
    if (midGoal[n].length != 0) {
      fillOption(detailGoal[n], detailedSelectedBox);
      break;
    }
  }
  // <!-- Fill Detailed Goal selection -->

  midSelectedBox.addEventListener('change', (e) => {
    let selectedNum = e.target.value;
    detailedSelectedBox.options.length = 0;
    switch (selectedNum) {
      case '0':
        fillOption(detailGoal[0], detailedSelectedBox);
        break;
      case '1':
        fillOption(detailGoal[1], detailedSelectedBox);
        break;
      case '2':
        fillOption(detailGoal[2], detailedSelectedBox);
        break;
      case '3':
        fillOption(detailGoal[3], detailedSelectedBox);
        break;
      case '4':
        fillOption(detailGoal[4], detailedSelectedBox);
        break;
      case '5':
        fillOption(detailGoal[5], detailedSelectedBox);
        break;
      case '6':
        fillOption(detailGoal[6], detailedSelectedBox);
        break;
      case '7':
        fillOption(detailGoal[7], detailedSelectedBox);
        break;
    }
  })
  // <!-- Add List -->
  const submitBtn = document.querySelector('.addBtn');
  const saveBtn = document.querySelector('.save-data');
  const selectedList = document.getElementById('selected-list');

  function deleteList(event) {
    const li = event.target.parentElement;
    li.remove();
  };
  
  submitBtn.addEventListener('click', () => {
    const li = document.createElement("li");
    const icon = document.createElement("span");
    const span = document.createElement("input");
    const hidden = document.createElement("input");
    const date = document.createElement("input");

    icon.className = "material-icons";
    icon.innerText = "check_circle";
    const button = document.createElement("button");
    button.setAttribute('type', 'button');
    button.innerText = "❌";
    li.className = "detailGoal";
    const midValue = midSelectedBox.options[midSelectedBox.selectedIndex].value;
    const detailValue = detailedSelectedBox.options[detailedSelectedBox.selectedIndex].value;
    const detailText = detailedSelectedBox.options[detailedSelectedBox.selectedIndex].text;
    const NameOfClass = midValue + detailValue;
    li.classList.add(NameOfClass);
    span.value = detailText;
    span.setAttribute('disabled', true);
    span.setAttribute('style', 'background-color:transparent;')
    hidden.value += NameOfClass;
    hidden.name = "spes";
    hidden.setAttribute('type', 'hidden');
    span.name = NameOfClass;
    button.addEventListener("click", deleteList);
    li.appendChild(icon);
    li.appendChild(span);
    li.appendChild(button);
    selectedList.appendChild(li);
    selectedList.appendChild(hidden);
  })
  saveBtn.addEventListener('click',()=>{
    const dateinput = document.getElementById('hdate');
    const selectedDate = document.getElementsByClassName('active')[0];
    const date = selectedDate.id.substr(0,4) + '-' + selectedDate.id.substr(4,2) +'-' +selectedDate.id.substr(6,2);
    dateinput.value = date;

  })
</script>
<script src="/static/js/calendar.js"></script>
{% endblock content %}